
<!DOCTYPE html>
<html>
<head>
    <title>Push Notifications</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        #status { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Test Web Push Notifications</h1>
    
    <div id="status">Statut: En attente...</div>
    
    <button onclick="activerNotifications()">üîî Activer les notifications</button>
    <button onclick="testerNotification()">üì® Envoyer une notification test</button>
    <button onclick="supprimerAbonnement()">üóëÔ∏è Supprimer mon abonnement</button>
    
    <script>
    async function activerNotifications() {
        const status = document.getElementById('status');
        
        try {
            // 1. V√©rifier le support
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                throw new Error('Push notifications non support√©es');
            }
            
            status.innerHTML = 'üì° Demande de permission...';
            
            // 2. Demander la permission
            const permission = await Notification.requestPermission();
            
            if (permission !== 'granted') {
                throw new Error('Permission refus√©e');
            }
            
            status.innerHTML = 'üîÑ Enregistrement du Service Worker...';
            
            // 3. Enregistrer le service worker
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('Service Worker enregistr√©:', registration);
            
            status.innerHTML = 'üîë Abonnement aux push...';
            
            // 4. S'abonner
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array('BIo_hsQ3pb93rTa8kjU1DjCjJZ1tMlGZ3YflnxJJLps0PrTpqwa5yqISByjZ-RiY7Tm14oiMDQDwuk7uQjhMR2s')
            });
            
            console.log('Abonnement cr√©√©:', subscription);
            
            status.innerHTML = 'üíæ Envoi au serveur...';
            
            // 5. Envoyer au serveur
            const response = await fetch('https://home-work-test.onrender.com/subscribe', {
                method: 'POST',
                body: JSON.stringify(subscription),
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
                throw new Error('Erreur serveur');
            }
            
            status.innerHTML = '‚úÖ <span class="success">Notifications activ√©es avec succ√®s !</span>';
            
        } catch (error) {
            status.innerHTML = `‚ùå <span class="error">Erreur: ${error.message}</span>`;
            console.error(error);
        }
    }
    
    async function testerNotification() {
        try {
            const response = await fetch('https://home-work-test.onrender.com/send-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: 'Test r√©ussi ! üéâ',
                    body: 'Les notifications push fonctionnent parfaitement'
                })
            });
            
            const data = await response.json();
            alert(`‚úÖ ${data.message}\nSucc√®s: ${data.success}\n√âchecs: ${data.failed}`);
            
        } catch (error) {
            alert('‚ùå Erreur: ' + error.message);
        }
    }
    
    async function supprimerAbonnement() {
        // Pour les tests - rafra√Æchit la page pour r√©initialiser
        if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (let reg of registrations) {
                await reg.unregister();
            }
        }
        localStorage.clear();
        alert('Abonnements supprim√©s, recharge la page');
        location.reload();
    }
    
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
    
    // V√©rification au chargement
    window.addEventListener('load', () => {
        if (Notification.permission === 'granted') {
            document.getElementById('status').innerHTML = '‚úÖ Notifications d√©j√† autoris√©es';
        }
    });
    </script>
</body>
</html>
